# docs https://github.com/marketplace/actions/create-release
# docs https://github.com/ncipollo/release-action
# docs https://docs.github.com/en/actions/using-jobs/choosing-the-runner-for-a-job#choosing-github-hosted-runners

name: release

on:
  workflow_run:
    workflows: ["CI Release"]
    types: ["completed"]

jobs:
  linux:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    permissions:
      contents: write
    steps:
      # electron build
      - uses: actions/checkout@v4
        with:
          # needed for git commit history changelog
          fetch-depth: 0
      - name: Get latest release tag
        id: previoustag
        uses: WyriHaximus/github-action-get-previous-tag@v1
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: yarn install --frozen-lockfile
      - run: CI='' yarn build
      - run: yarn electron:build:linux
      - run: ls dist

      # verify executable works
      - name: Install xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb
      - name: Verify AppImage executable
        run: |
          chmod +x dist/plebones-*.AppImage
          xvfb-run --auto-servernum --server-args="-screen 0 1024x768x24" \
            node scripts/verify-executable.js "$(ls dist/plebones-*.AppImage | head -1)"
        timeout-minutes: 5

      # publish version release
      - run: node scripts/release-body > release-body.txt
      - uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.previoustag.outputs.tag }}
          artifacts: 'dist/plebones*.AppImage,dist/plebones-html*.zip'
          token: ${{ secrets.GITHUB_TOKEN }}
          replacesArtifacts: true
          bodyFile: "release-body.txt"
          allowUpdates: true

  mac:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: macos-14
    timeout-minutes: 60
    permissions:
      contents: write
    steps:
      # electron build
      - uses: actions/checkout@v4
        with:
          # needed for git commit history changelog
          fetch-depth: 0
      - name: Get latest release tag
        id: previoustag
        uses: WyriHaximus/github-action-get-previous-tag@v1
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # install missing dep for sqlite
      - run: pip install setuptools

      - run: yarn install --frozen-lockfile
      - run: CI='' yarn build
      - run: yarn electron:build:mac
      - run: ls dist

      # verify executable works
      - name: Verify macOS executable
        run: |
          DMG_FILE=$(ls dist/plebones-*.dmg | head -1)
          hdiutil attach "$DMG_FILE" -nobrowse -quiet
          APP_PATH="/Volumes/plebones/plebones.app/Contents/MacOS/plebones"
          node scripts/verify-executable.js "$APP_PATH" || EXIT_CODE=$?
          hdiutil detach "/Volumes/plebones" -quiet || true
          exit ${EXIT_CODE:-0}
        timeout-minutes: 5

      # publish version release
      - run: node scripts/release-body > release-body.txt
      - uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.previoustag.outputs.tag }}
          artifacts: 'dist/plebones*.dmg'
          token: ${{ secrets.GITHUB_TOKEN }}
          replacesArtifacts: true
          bodyFile: "release-body.txt"
          allowUpdates: true

  windows:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: windows-2022
    timeout-minutes: 60
    permissions:
      contents: write
    steps:
      # electron build
      - uses: actions/checkout@v4
        with:
          # needed for git commit history changelog
          fetch-depth: 0
      - name: Get latest release tag
        id: previoustag
        uses: WyriHaximus/github-action-get-previous-tag@v1
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: yarn install --frozen-lockfile
      - run: yarn build
      - run: yarn electron:build:windows
      - run: dir dist

      # verify executable works
      - name: Verify Windows executable
        run: |
          $exePath = Get-ChildItem -Path dist -Filter "plebones-*.exe" | Where-Object { $_.Name -notmatch "Setup" } | Select-Object -First 1 -ExpandProperty FullName
          node scripts/verify-executable.js $exePath
        timeout-minutes: 5
        shell: pwsh

      # publish version release
      - run: node scripts/release-body > release-body.txt
      - uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.previoustag.outputs.tag }}
          artifacts: 'dist/plebones*.exe'
          token: ${{ secrets.GITHUB_TOKEN }}
          replacesArtifacts: true
          bodyFile: "release-body.txt"
          allowUpdates: true

  android:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          # needed to use 'git tag' and get all tags and for git commit history changelog
          fetch-depth: 0
      - name: Get latest release tag
        id: previoustag
        uses: WyriHaximus/github-action-get-previous-tag@v1
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      - uses: gradle/actions/setup-gradle@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: sudo apt install -y apksigner zipalign

      # build react app
      - run: yarn install --frozen-lockfile
      - run: CI='' yarn build
      # set android versionCode and versionName
      - run: sed -i "s/versionCode 1/versionCode $(git tag | wc -l)/" ./android/app/build.gradle
      - run: sed -i "s/versionName \"1.0\"/versionName \"$(node -e "console.log(require('./package.json').version)")\"/" ./android/app/build.gradle
      - run: cat ./android/app/build.gradle
      # build apk
      - run: npx cap update
      - run: npx cap copy
      - run: cd android && ./gradlew bundle
      - run: cd android && ./gradlew assembleRelease
      # optimize apk
      - run: cd android/app/build/outputs/apk/release && zipalign 4 app-release-unsigned.apk app-release-unsigned-zip.apk
      # sign apk
      # to create keystore: keytool -genkey -v -keystore plebbit.keystore -keyalg RSA -keysize 2048 -validity 10000 -alias release
      - run: cd android/app/build/outputs/apk/release && apksigner sign --ks ../../../../../plebbit.keystore --ks-pass pass:${{ secrets.PLEBBIT_REACT_KEYSTORE_PASSWORD }} --ks-key-alias release --out app-release-signed.apk app-release-unsigned-zip.apk
      # move apk to dist folder
      - run: mkdir -p dist && mv android/app/build/outputs/apk/release/app-release-signed.apk dist/plebones-$(node -e "console.log(require('./package.json').version)").apk
      - run: ls dist

      # publish version release
      - run: node scripts/release-body > release-body.txt
      - uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.previoustag.outputs.tag }}
          artifacts: 'dist/plebones*.apk'
          token: ${{ secrets.GITHUB_TOKEN }}
          replacesArtifacts: true
          bodyFile: "release-body.txt"
          allowUpdates: true
